<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Utility Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f7fb; }
    h1 { color:#2563eb; }
    .card { background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    label { font-weight:600; }
    input, select, button { margin:6px 0; padding:6px; border-radius:6px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#2563eb; color:white; }
    canvas { background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
    #btnCleanUp { background:#dc2626; color:white; font-weight:bold; cursor:pointer; }
    #btnCleanUp:disabled { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Utility Monitoring</h1>

  <!-- Input -->
  <div class="card">
    <h2>Input Data</h2>
    <label>Pilih Kategori:</label>
    <select id="kategori">
      <option value="PLN">PLN</option>
      <option value="WATER">Water Meter</option>
      <option value="LVMDP">LVMDP</option>
      <option value="AHU">AHU</option>
      <option value="TENANT">Tenant</option>
    </select><br>
    <label>Hari Ini:</label>
    <input type="number" id="todayValue"><br>
    <button onclick="saveData()">Simpan</button>
    <div id="yesterday"></div>
    <div id="summary"></div>
  </div>

  <!-- Dashboard -->
  <div class="card">
    <h2>Dashboard</h2>
    <label>Kategori:</label>
    <select id="dashKategori">
      <option value="PLN">PLN</option>
      <option value="WATER">Water Meter</option>
    </select>
    <label>Bulan:</label>
    <input type="month" id="dashMonth" value="2025-09">
    <button onclick="loadDashboard()">Tampilkan</button>
    <div>
      <canvas id="chart" height="120"></canvas>
    </div>
    <button onclick="exportExcel()">Export Excel</button>

    <!-- Tambahan tombol Clean Up -->
    <button id="btnCleanUp" onclick="confirmAndClean()">ðŸ”§ Clean Up (hapus data > 60 hari)</button>
    <div id="cleanProgress" style="margin-top:8px;color:#444"></div>
  </div>

  <table id="rekapTable"></table>

  <script>
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA9cPZlGt6nfcTqfo0H0_Jfd4RaVWOk--4",
  authDomain: "utilitymonitoring.firebaseapp.com",
  projectId: "utilitymonitoring",
  storageBucket: "utilitymonitoring.firebasestorage.appspot.com",
  messagingSenderId: "427253616217",
  appId: "1:427253616217:web:05032969604a91c4552b48",
  measurementId: "G-4CE9GYWEPP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === Simpan Data ===
    async function saveData(){
      const kategori = document.getElementById("kategori").value;
      const today = document.getElementById("todayValue").value;
      const date = new Date().toISOString().slice(0,10); // YYYY-MM-DD

      if(!today) return alert("Isi angka dulu!");

      await db.collection("utility_usage").doc(kategori)
        .collection("readings").doc(date).set({
          value: Number(today),
          timestamp: new Date()
        });

      alert("Data tersimpan!");
      loadYesterday(kategori);
    }

    // === Ambil data kemarin ===
    async function loadYesterday(kategori){
      const snap = await db.collection("utility_usage").doc(kategori)
        .collection("readings").orderBy("timestamp","desc").limit(2).get();
      const docs = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(docs.length>=2){
        const yesterday = docs[1].value;
        const today = docs[0].value;
        document.getElementById("yesterday").innerText =
          `Kemarin: ${yesterday}, Hari ini: ${today}`;
        document.getElementById("summary").innerText =
          `Naik ${(today - yesterday).toFixed(2)}`;
      }
    }

    // === Dashboard ===
    async function loadDashboard(){
      const kategori = document.getElementById("dashKategori").value;
      const month = document.getElementById("dashMonth").value; // yyyy-mm

      const snap = await db.collection("utility_usage").doc(kategori)
        .collection("readings").orderBy("timestamp","asc").get();
      const data = snap.docs.map(d=>({id:d.id,...d.data()}))
        .filter(d=>d.id.startsWith(month));

      // Tabel
      let html = "<tr><th>Tanggal</th><th>Value</th></tr>";
      const labels = [], values=[];
      data.forEach(d=>{
        labels.push(d.id);
        values.push(d.value);
        html += `<tr><td>${d.id}</td><td>${d.value}</td></tr>`;
      });
      document.getElementById("rekapTable").innerHTML = html;

      // Grafik
      new Chart(document.getElementById("chart"),{
        type:"line",
        data:{labels:labels, datasets:[{label:kategori,data:values,borderColor:"#2563eb"}]},
        options:{responsive:true, maintainAspectRatio:false}
      });
    }

    // === Export Excel ===
    function exportExcel(){
      const table = document.getElementById("rekapTable");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Rekap");
      XLSX.writeFile(wb, "Rekap.xlsx");
    }

    // === Clean Up Function (hapus data lama) ===
    async function cleanOldReadings(days = 60) {
      const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
      const progressEl = document.getElementById('cleanProgress');
      progressEl.innerText = `Mencari dokumen yang lebih tua dari ${days} hari...`;

      let totalDeleted = 0;
      const pageSize = 500;

      while (true) {
        const q = db.collectionGroup('readings')
          .where('timestamp', '<', cutoff)
          .limit(pageSize);
        const snap = await q.get();
        if (snap.empty) break;

        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();

        totalDeleted += snap.size;
        progressEl.innerText = `Terhapus ${totalDeleted} dokumen...`;

        if (snap.size < pageSize) break;
      }

      progressEl.innerText = `Selesai. Total dokumen terhapus: ${totalDeleted}`;
      return totalDeleted;
    }

    async function confirmAndClean() {
      if (!confirm("Anda yakin akan menghapus data lama (> 60 hari)?")) return;
      const btn = document.getElementById('btnCleanUp');
      btn.disabled = true;
      try {
        const deleted = await cleanOldReadings(60);
        alert(`Selesai. Terhapus ${deleted} dokumen lama.`);
      } catch (err) {
        console.error(err);
        alert("Error saat hapus data");
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
