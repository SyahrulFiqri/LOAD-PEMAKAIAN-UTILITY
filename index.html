<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Utility - Input & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{--bg:#f5f7fb;--card:#fff;--primary:#2563eb;--muted:#6b7280}
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:18px;color:#0f172a}
    .container{max-width:1200px;margin:0 auto}
    h1{color:var(--primary);margin-bottom:6px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:14px}
    label{display:block;font-weight:700;color:var(--muted);font-size:13px}
    select,input,button{padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fff}
    .controls{display:flex;gap:12px;align-items:end;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border:1px solid #e6eefb;padding:8px;text-align:center}
    thead th{background:linear-gradient(90deg,#1e3a8a,#3b82f6);color:#fff}
    input[type="number"]{width:120px}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
    .btn-primary{background:var(--primary)}
    .btn-danger{background:#dc2626}
    .btn-ghost{background:#64748b}
    .small{width:100px}
    .flex{display:flex;gap:8px;align-items:center}
    #summary{margin-top:10px;padding:10px;border-left:4px solid var(--primary);background:#eef2ff;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š Utility Input & Dashboard</h1>

    <div class="card">
      <div class="controls">
        <div>
          <label>Tanggal (untuk export / referensi)</label>
          <input type="date" id="globalDate" />
        </div>

        <div>
          <label>Pilih Kategori</label>
          <select id="kategori" onchange="renderCategory()">
            <option value="">-- pilih kategori --</option>
            <option value="PLN">PLN</option>
            <option value="LVMDP">LVMDP</option>
            <option value="AHU">AHU</option>
            <option value="WATER">WATER METER</option>
          </select>
        </div>

        <div style="margin-left:auto" class="actions">
          <button class="btn btn-primary" onclick="saveVisible()">Simpan</button>
          <button class="btn btn-primary" onclick="exportCurrent()">Export Sheet</button>
          <button class="btn btn-ghost" onclick="exportAll()">Export Semua</button>
        </div>
      </div>

      <div id="formArea" style="margin-top:12px"></div>
      <div id="summary" style="display:none"></div>
    </div>

    <div class="card">
      <h3>Dashboard Cepat</h3>
      <div class="flex">
        <label>Kategori</label>
        <select id="dashCat">
          <option value="PLN">PLN</option>
          <option value="LVMDP">LVMDP</option>
          <option value="AHU">AHU</option>
          <option value="WATER">WATER METER</option>
        </select>
        <label>Bulan</label>
        <input type="month" id="dashMonth" value="">
        <button class="btn btn-primary" onclick="loadDashboard()">Tampilkan</button>
        <button class="btn btn-ghost" onclick="clearChart()">Clear Chart</button>
      </div>
      <div style="margin-top:12px">
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>
  </div>

<script>
/* ========= ============  GANTI DENGAN FIREBASE CONFIG PROJECTMU  ============ ============
  Ambil dari Firebase Console > Project settings > Your apps (Web) -> config
  contoh:
  const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "projectid.appspot.com", ... };
============================================================================= */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA9cPZlGt6nfcTqfo0H0_Jfd4RaVWOk--4",
  authDomain: "utilitymonitoring.firebaseapp.com",
  projectId: "utilitymonitoring",
  storageBucket: "utilitymonitoring.firebasestorage.app",
  messagingSenderId: "427253616217",
  appId: "1:427253616217:web:05032969604a91c4552b48",
  measurementId: "G-4CE9GYWEPP"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ======= Helpers tanggal ======= */
function todayId(){
  const d = new Date();
  return d.toISOString().slice(0,10); // YYYY-MM-DD
}
function formatDateLocal(isoDate){
  const d = new Date(isoDate);
  return d.toLocaleString();
}

/* ======= Templates rendering per kategori ======= */

function renderCategory(){
  const cat = document.getElementById('kategori').value;
  const area = document.getElementById('formArea');
  document.getElementById('summary').style.display='none';
  if(!cat){ area.innerHTML = '<div class="muted">Pilih kategori untuk tampilkan form input.</div>'; return; }

  if(cat === 'PLN'){
    area.innerHTML = renderPLNForm();
    // after render, try auto-fill from yesterday's 'akhir'
    autoFillPLNStarts();
  } else if(cat === 'LVMDP'){
    area.innerHTML = renderLVMDPForm();
  } else if(cat === 'AHU'){
    area.innerHTML = renderAHUForm();
  } else if(cat === 'WATER'){
    area.innerHTML = renderWaterForm();
  }
}

/* ---------- PLN form (LWBP/WBP/KVARh) ---------- */
function renderPLNForm(){
  return `
    <h3>PLN (AMR)</h3>
    <table id="tblPLN"><thead>
      <tr><th>Meter</th><th>Stand Awal</th><th>Stand Akhir</th><th>Pemakaian</th></tr>
    </thead><tbody>
      <tr data-meter="lwbp">
        <td>LWBP (kWh)</td>
        <td><input type="number" data-field="lwbpAwal" /></td>
        <td><input type="number" data-field="lwbpAkhir" /></td>
        <td><div data-field="lwbpPakai" class="muted"></div></td>
      </tr>
      <tr data-meter="wbp">
        <td>WBP (kWh)</td>
        <td><input type="number" data-field="wbpAwal" /></td>
        <td><input type="number" data-field="wbpAkhir" /></td>
        <td><div data-field="wbpPakai" class="muted"></div></td>
      </tr>
      <tr data-meter="kvar">
        <td>KVARh</td>
        <td><input type="number" data-field="kvarAwal" /></td>
        <td><input type="number" data-field="kvarAkhir" /></td>
        <td><div data-field="kvarPakai" class="muted"></div></td>
      </tr>
      <tr>
        <td><strong>Total kWh</strong></td>
        <td colspan="3"><div data-field="totalKwh" class="muted"></div></td>
      </tr>
      <tr>
        <td><strong>Keterangan</strong></td>
        <td colspan="3"><small class="muted">Stand Awal akan terisi otomatis dari Stand Akhir kemarin jika tersedia.</small></td>
      </tr>
    </tbody></table>
  `;
}

/* auto fill PLN starts from last saved 'akhir' doc */
async function autoFillPLNStarts(){
  try{
    const cat = 'PLN';
    const colRef = db.collection('utility_usage').doc(cat).collection('readings');
    // ambil latest doc (berdasarkan timestamp desc)
    const snap = await colRef.orderBy('timestamp','desc').limit(1).get();
    if(snap.empty) return;
    const last = snap.docs[0].data();
    // last may contain lwbpAkhir, wbpAkhir, kvarAkhir at doc fields; our save format will store these
    // if last has lwbpAkhir etc, put them into the 'awal' inputs
    ['lwbpAkhir','wbpAkhir','kvarAkhir'].forEach(key=>{
      const el = document.querySelector(`[data-field="${key.replace('Akhir','Awal')}"]`);
      const value = last[key];
      if(el && value !== undefined) el.value = value;
    });
  }catch(e){
    console.error('autoFillPLNStarts error', e);
  }
}

/* ---------- LVMDP form (default 4 rows) ---------- */
function renderLVMDPForm(){
  const names = ['LVMDP1','LVMDP2','LVMDP3','LVMDP4'];
  let rows = names.map(n=>{
    return `<tr>
      <td><input type="text" data-field="name" value="${n}" readonly/></td>
      <td><input type="number" data-field="pemakaian" /></td>
      <td><div class="muted" data-field="mwh"></div></td>
    </tr>`;
  }).join('');
  return `<h3>LVMDP (MWh)</h3>
    <table id="tblLVMDP"><thead><tr><th>Nama Panel</th><th>Pemakaian Hari Ini (MWh)</th><th>Catatan</th></tr></thead><tbody>${rows}</tbody></table>
    <div class="muted">Isi pemakaian per panel (satuan MWh).</div>`;
}

/* ---------- AHU form (default SDB-AC.*) ---------- */
function renderAHUForm(){
  const names = ['SDB-AC.A','SDB-AC.B','SDB-AC.C','SDB-AC.D'];
  let rows = names.map(n=>{
    return `<tr>
      <td><input type="text" data-field="name" value="${n}" readonly/></td>
      <td><input type="number" data-field="pemakaian" /></td>
      <td><div class="muted" data-field="note"></div></td>
    </tr>`;
  }).join('');
  return `<h3>AHU (kWh)</h3>
    <table id="tblAHU"><thead><tr><th>Nama Panel</th><th>Pemakaian Hari Ini (kWh)</th><th>Catatan</th></tr></thead><tbody>${rows}</tbody></table>
    <div class="muted">Isi angka pemakaian kWh per panel.</div>`;
}

/* ---------- WATER form (dynamic rows) ---------- */
function renderWaterForm(){
  return `<h3>Water Meter</h3>
    <div style="margin-bottom:8px"><button class="btn btn-primary" onclick="addWaterRow()">+ Tambah Baris</button></div>
    <table id="tblWATER"><thead><tr><th>Nama</th><th>Pemakaian Hari Ini (mÂ³)</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    <div class="muted">Tambahkan sumber air lalu isi pemakaian hari ini (mÂ³).</div>`;
}
function addWaterRow(name='') {
  const tbody = document.querySelector('#tblWATER tbody');
  const row = document.createElement('tr');
  row.innerHTML = `<td><input type="text" data-field="name" value="${name}" /></td>
    <td><input type="number" data-field="pemakaian" /></td>
    <td><button onclick="this.closest('tr').remove()" class="btn btn-ghost">Hapus</button></td>`;
  tbody.appendChild(row);
}

/* ======= Save visible form to Firestore ======= */
async function saveVisible(){
  const cat = document.getElementById('kategori').value;
  if(!cat) return alert('Pilih kategori dulu');
  const date = (document.getElementById('globalDate').value) ? document.getElementById('globalDate').value : todayId();
  const docRef = db.collection('utility_usage').doc(cat).collection('readings').doc(date);

  try{
    if(cat === 'PLN'){
      // read inputs
      const lwbpAwal = Number(document.querySelector('[data-field="lwbpAwal"]').value || 0);
      const lwbpAkhir = Number(document.querySelector('[data-field="lwbpAkhir"]').value || 0);
      const wbpAwal = Number(document.querySelector('[data-field="wbpAwal"]').value || 0);
      const wbpAkhir = Number(document.querySelector('[data-field="wbpAkhir"]').value || 0);
      const kvarAwal = Number(document.querySelector('[data-field="kvarAwal"]').value || 0);
      const kvarAkhir = Number(document.querySelector('[data-field="kvarAkhir"]').value || 0);

      const lwbpPakai = lwbpAkhir - lwbpAwal;
      const wbpPakai = wbpAkhir - wbpAwal;
      const kvarPakai = kvarAkhir - kvarAwal;
      const totalKwh = (lwbpPakai || 0) + (wbpPakai || 0);

      // set visual
      document.querySelector('[data-field="lwbpPakai"]').innerText = lwbpPakai;
      document.querySelector('[data-field="wbpPakai"]').innerText = wbpPakai;
      document.querySelector('[data-field="kvarPakai"]').innerText = kvarPakai;
      document.querySelector('[data-field="totalKwh"]').innerText = totalKwh;

      // save structured doc
      await docRef.set({
        timestamp: new Date(),
        lwbpAwal, lwbpAkhir, lwbpPakai,
        wbpAwal, wbpAkhir, wbpPakai,
        kvarAwal, kvarAkhir, kvarPakai,
        totalKwh
      }, { merge: true });

      showSummaryPLN(docRef);
      alert('PLN: Data tersimpan.');
    }

    else if(cat === 'LVMDP'){
      // collect each row
      const rows = Array.from(document.querySelectorAll('#tblLVMDP tbody tr'));
      const data = rows.map(r=>{
        const name = r.querySelector('[data-field="name"]').value;
        const pemakaian = Number(r.querySelector('[data-field="pemakaian"]').value || 0);
        return { name, pemakaian };
      });
      await docRef.set({ timestamp: new Date(), items: data }, { merge: true });
      alert('LVMDP: Data tersimpan.');
    }

    else if(cat === 'AHU'){
      const rows = Array.from(document.querySelectorAll('#tblAHU tbody tr'));
      const data = rows.map(r=>{
        const name = r.querySelector('[data-field="name"]').value;
        const pemakaian = Number(r.querySelector('[data-field="pemakaian"]').value || 0);
        return { name, pemakaian };
      });
      await docRef.set({ timestamp: new Date(), items: data }, { merge: true });
      alert('AHU: Data tersimpan.');
    }

    else if(cat === 'WATER'){
      const rows = Array.from(document.querySelectorAll('#tblWATER tbody tr'));
      const data = rows.map(r=>{
        const name = r.querySelector('[data-field="name"]').value;
        const pemakaian = Number(r.querySelector('[data-field="pemakaian"]').value || 0);
        return { name, pemakaian };
      });
      await docRef.set({ timestamp: new Date(), items: data }, { merge: true });
      alert('Water Meter: Data tersimpan.');
    }

  }catch(err){
    console.error('saveVisible error', err);
    alert('Gagal menyimpan data. Cek console untuk detail.');
  }
}

/* helper show simple summary for PLN */
async function showSummaryPLN(docRef){
  try{
    const doc = await docRef.get();
    if(!doc.exists) return;
    const d = doc.data();
    const prevSnap = await db.collection('utility_usage').doc('PLN').collection('readings')
      .orderBy('timestamp','desc').limit(2).get();
    if(prevSnap.size>=2){
      const docs = prevSnap.docs.map(x=>x.data());
      const kemarin = docs[1].totalKwh || 0;
      const hariIni = docs[0].totalKwh || 0;
      const naik = hariIni - kemarin;
      const el = document.getElementById('summary');
      el.style.display='block';
      el.innerHTML = `<strong>PEMAKAIAN KWH PLN</strong><br/>Kemarin: ${kemarin} kWh<br/>Hari ini: ${hariIni} kWh<br/>Naik: ${naik} kWh`;
    }
  }catch(e){ console.error(e); }
}

/* ===== Dashboard: query monthly and show chart ===== */
let chartInstance = null;
async function loadDashboard(){
  const cat = document.getElementById('dashCat').value;
  const month = document.getElementById('dashMonth').value; // yyyy-mm
  if(!month) return alert('Pilih bulan dulu');

  // get all docs for category, then filter by id startsWith month
  const snap = await db.collection('utility_usage').doc(cat).collection('readings')
    .orderBy('timestamp','asc').get();
  const data = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(x=>x.id.startsWith(month));
  if(data.length===0) return alert('Tidak ada data untuk bulan ini.');

  // build labels & values: for PLN use totalKwh if present, else items for other categories
  const labels = [];
  const values = [];
  data.forEach(d=>{
    labels.push(d.id);
    if(cat === 'PLN') values.push(d.totalKwh || 0);
    else if(d.items){
      // sum items
      const sum = d.items.reduce((s,it)=>s + (it.pemakaian||0),0);
      values.push(sum);
    } else {
      values.push(d.value || 0);
    }
  });

  const ctx = document.getElementById('chart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: cat, data: values, borderColor: '#2563eb', tension:0.2 }] },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

/* clear chart */
function clearChart(){ if(chartInstance){ chartInstance.destroy(); chartInstance=null; } }

/* ===== Export functions ===== */

/* export current visible table (DOM) */
function exportCurrent(){
  const cat = document.getElementById('kategori').value || document.getElementById('dashCat').value;
  if(!cat) return alert('Pilih kategori dulu (untuk export sheet aktif).');
  // try to export data by reading today's doc from Firestore (better than DOM)
  const date = document.getElementById('globalDate').value || todayId();
  db.collection('utility_usage').doc(cat).collection('readings').doc(date).get()
    .then(doc=>{
      const wb = XLSX.utils.book_new();
      let aoa = [];
      if(!doc.exists){
        aoa = [['No data for', date]];
      } else {
        const data = doc.data();
        if(cat === 'PLN'){
          aoa = [['Meter','Awal','Akhir','Pakai'], 
            ['LWBP', data.lwbpAwal||0, data.lwbpAkhir||0, data.lwbpPakai||0],
            ['WBP', data.wbpAwal||0, data.wbpAkhir||0, data.wbpPakai||0],
            ['KVARh', data.kvarAwal||0, data.kvarAkhir||0, data.kvarPakai||0],
            ['Total kWh', data.totalKwh||0]
          ];
        } else {
          aoa = [['Name','Pemakaian']];
          (data.items||[]).forEach(it=> aoa.push([it.name, it.pemakaian]));
        }
      }
      const ws = XLSX.utils.aoa_to_sheet([['Tanggal:', date], [], ...aoa]);
      XLSX.utils.book_append_sheet(wb, ws, cat.substring(0,31));
      XLSX.writeFile(wb, `Pemakaian_${cat}_${date}.xlsx`);
    }).catch(err=>{ console.error(err); alert('Gagal export: '+err.message); });
}

/* exportAll - get month from dashMonth and export all categories into workbook */
async function exportAll(){
  const month = document.getElementById('dashMonth').value;
  if(!month) return alert('Pilih bulan di Dashboard (untuk exportAll)');
  const cats = ['PLN','LVMDP','AHU','WATER'];
  const wb = XLSX.utils.book_new();

  for(const cat of cats){
    const snap = await db.collection('utility_usage').doc(cat).collection('readings').orderBy('timestamp','asc').get();
    const rows = snap.docs.map(d=>({id:d.id, ...d.data()})).filter(x=>x.id.startsWith(month));
    let aoa = [];
    if(cat === 'PLN'){
      aoa.push(['Tanggal','LWBP Awal','LWBP Akhir','LWBP Pakai','WBP Awal','WBP Akhir','WBP Pakai','KVAR Awal','KVAR Akhir','KVAR Pakai','Total kWh']);
      rows.forEach(r=>{
        aoa.push([r.id, r.lwbpAwal||0, r.lwbpAkhir||0, r.lwbpPakai||0, r.wbpAwal||0, r.wbpAkhir||0, r.wbpPakai||0, r.kvarAwal||0, r.kvarAkhir||0, r.kvarPakai||0, r.totalKwh||0]);
      });
    } else {
      aoa.push(['Tanggal','Name','Pemakaian']);
      rows.forEach(r=>{
        (r.items||[]).forEach(it=>{
          aoa.push([r.id, it.name, it.pemakaian]);
        });
      });
    }
    const ws = XLSX.utils.aoa_to_sheet([[`Category: ${cat}`], [`Bulan: ${month}`],[], ...aoa]);
    XLSX.utils.book_append_sheet(wb, ws, cat.substring(0,31));
  }

  XLSX.writeFile(wb, `Pemakaian_All_${month}.xlsx`);
}

/* ===== Optional: Clean Up manual (keberadaan tombol ada di layout) =====
   Jika ingin non-aktifkan fitur ini, tinggal hapus tombol pada HTML.
*/
async function cleanOldReadings(days = 60) {
  const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
  const progressEl = document.getElementById('cleanProgress');
  progressEl && (progressEl.innerText = `Mencari dokumen yang lebih tua dari ${days} hari...`);
  let totalDeleted = 0;
  const pageSize = 500;
  while (true) {
    const q = db.collectionGroup('readings').where('timestamp','<', cutoff).limit(pageSize);
    const snap = await q.get();
    if (snap.empty) break;
    const batch = db.batch();
    snap.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    totalDeleted += snap.size;
    progressEl && (progressEl.innerText = `Terhapus ${totalDeleted} dokumen...`);
    if (snap.size < pageSize) break;
  }
  progressEl && (progressEl.innerText = `Selesai. Total dokumen terhapus: ${totalDeleted}`);
  return totalDeleted;
}
async function confirmAndClean(){
  if(!confirm('Yakin hapus data > 60 hari?')) return;
  const btn = document.getElementById('btnCleanUp');
  btn && (btn.disabled = true);
  try { const del = await cleanOldReadings(60); alert('Selesai. Terhapus: '+del); }
  catch(e){ console.error(e); alert('Error: '+e.message); }
  finally { btn && (btn.disabled = false); }
}

/* ===== init default: set dashMonth to current month ===== */
(function init(){
  const m = new Date(); const month = m.toISOString().slice(0,7);
  document.getElementById('dashMonth').value = month;
  document.getElementById('globalDate').value = todayId();
  document.getElementById('formArea').innerHTML = '<div class="muted">Pilih kategori untuk menampilkan form input.</div>';
})();
</script>
</body>
</html>
