<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Utility - All Categories</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --primary:#2563eb; --accent:#f59e0b; --ok:#16a34a;
      --muted:#6b7280; --radius:10px;
    }
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:18px;color:#0f172a}
    .container{max-width:1200px;margin:0 auto}
    h1{margin:6px 0 12px;color:var(--primary)}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-top:14px}
    label{font-weight:600;color:var(--muted);font-size:13px}
    select,input[type="date"],.smallinput{padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fff}
    button{border:0;padding:9px 12px;border-radius:10px;font-weight:700;color:#fff;cursor:pointer}
    .btn-primary{background:var(--primary)} .btn-accent{background:var(--accent)} .btn-ok{background:var(--ok)}
    .btn-ghost{background:#64748b;opacity:0.95}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
    th,td{border:1px solid #e6eefb;padding:8px;text-align:center}
    thead th{background:linear-gradient(90deg,#1e3a8a,#3b82f6);color:white;font-weight:700}
    tbody tr:nth-child(even){background:#fbfdff}
    input[type="number"], input[type="text"]{width:100%;box-sizing:border-box;padding:6px;border-radius:6px;border:1px solid #dbeafe}
    .small{width:80px}
    .muted{color:var(--muted);font-size:13px}
    .flex-row{display:flex;gap:8px;align-items:center}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .note{font-size:13px;color:var(--muted);margin-top:8px}
    @media (max-width:900px){
      table, thead, tbody, tr, th, td { font-size:12px }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>ðŸ“Š Load Pemakaian Utility </h1>
        <div class="muted"> AMR PLN, HOTEL, LVMDP, WATER METER, AHU, TENANT, LIFT-ESC</div>
	<div class="muted"> By : Syahrul Fiqri
      </div>

     </div>

    <div class="card">
      <div class="controls">
        <div>
          <label>Tanggal (untuk header export)</label><br>
          <input type="date" id="globalDate" />
        </div>

        <div>
          <label>Pilih Kategori</label><br>
          <select id="kategori" onchange="changeCategory()">
            <option value="">-- pilih kategori --</option>
            <option value="AMR PLN">AMR PLN</option>
            <option value="HOTEL">HOTEL</option>
            <option value="LVMDP">LVMDP</option>
            <option value="WATER METER">WATER METER</option>
            <option value="AHU">AHU</option>
            <option value="TENANT">TENANT</option>
            <option value="LIFT-ESC">LIFT-ESC</option>
          </select>
        </div>

        <div style="margin-left:auto" class="actions">
          <button class="btn-accent" onclick="addRow()">+ Tambah Baris</button>
          <button class="btn-ok" onclick="calculate()">Hitung</button>
          <button class="btn-primary" onclick="exportCurrent()">Export Sheet</button>
          <button class="btn-ghost" onclick="exportAll()">Export Semua</button>
        </div>
      </div>

      <div id="formArea" style="margin-top:14px"></div>
      <div class="note">Tips: isi <strong>Stand Awal</strong> & <strong>Stand Akhir</strong> lalu tekan <strong>Hitung</strong>. Untuk ekspor gunakan tombol <strong>Export Sheet</strong> (hanya sheet aktif) atau <strong>Export Semua</strong> (semua kategori yang sudah dibuat akan diexport ke workbook).</div>
    </div>
  </div>

  <script>
    // ----- Template definitions for each category -----
    // These templates use a simple descriptor array to build table headers and cells.
    // For AMR PLN and HOTEL we've matched to your file (AMR PLN: LWBP/WBP/KVARh groups; HOTEL: power meter rows).
    const templates = {
      "AMR PLN": {
        cols: [
          {title:"No", span:1, field:"no"},
          {title:"Nama", span:1, field:"name"},
          {group:"LWBP (kWh)", fields:[
            {title:"Awal", field:"lwbpAwal"},
            {title:"Akhir", field:"lwbpAkhir"},
            {title:"Pakai", field:"lwbpPakai", readonly:true},
            {title:"Hari", field:"lwbpHari"}
          ]},
          {group:"WBP (kWh)", fields:[
            {title:"Awal", field:"wbpAwal"},
            {title:"Akhir", field:"wbpAkhir"},
            {title:"Pakai", field:"wbpPakai", readonly:true},
            {title:"Hari", field:"wbpHari"}
          ]},
          {group:"KVARh", fields:[
            {title:"Awal", field:"kvarAwal"},
            {title:"Akhir", field:"kvarAkhir"},
            {title:"Pakai", field:"kvarPakai", readonly:true},
            {title:"Hari", field:"kvarHari"}
          ]},
          {title:"Total kWh", span:1, field:"totalKwh", readonly:true},
          {title:"Rata-rata/Hari", span:1, field:"avgPerDay", readonly:true}
        ]
      },

      "HOTEL": {
        // Based on your uploaded sheet preview: columns for date + POWER METER (WBP/LWBP) + Pemakaian + Total + Hari name
        cols: [
          {title:"No", field:"no"},
          {title:"Tanggal", field:"tanggal"},
          {group:"Power Meter (kWh)", fields:[
            {title:"WBP Awal", field:"hotelWbpAwal"},
            {title:"WBP Akhir", field:"hotelWbpAkhir"},
            {title:"WBP Pakai", field:"hotelWbpPakai", readonly:true}
          ]},
          {group:"LWBP (kWh)", fields:[
            {title:"LWBP Awal", field:"hotelLwbpAwal"},
            {title:"LWBP Akhir", field:"hotelLwbpAkhir"},
            {title:"LWBP Pakai", field:"hotelLwbpPakai", readonly:true}
          ]},
          {title:"Total KWH", field:"hotelTotal", readonly:true},
          {title:"Hari (nama)", field:"hariNama"}
        ]
      },

      "LVMDP": {
        cols:[
          {title:"No", field:"no"},
          {title:"Nama Panel", field:"name"},
          {title:"Stand Awal", field:"awal"},
          {title:"Stand Akhir", field:"akhir"},
          {title:"Pemakaian", field:"pakai", readonly:true},
          {title:"Hari", field:"hari"},
          {title:"Rata-rata/Hari", field:"avg", readonly:true}
        ]
      },

      "WATER METER": {
        cols:[
          {title:"No", field:"no"},
          {title:"Tanggal", field:"tanggal"},
          {title:"Meter No", field:"meterNo"},
          {title:"Stand Awal (m3)", field:"awal"},
          {title:"Stand Akhir (m3)", field:"akhir"},
          {title:"Pemakaian (m3)", field:"pakai", readonly:true},
          {title:"Hari", field:"hari"},
          {title:"Rata-rata/Hari", field:"avg", readonly:true}
        ]
      },

      "AHU": {
        cols:[
          {title:"No", field:"no"},
          {title:"Nama AHU", field:"name"},
          {title:"Run Hour Awal", field:"rhAwal"},
          {title:"Run Hour Akhir", field:"rhAkhir"},
          {title:"Run Hour (Pakai)", field:"rhPakai", readonly:true},
          {title:"Energy kWh Awal", field:"engAwal"},
          {title:"Energy kWh Akhir", field:"engAkhir"},
          {title:"Energy kWh Pakai", field:"engPakai", readonly:true},
          {title:"Hari", field:"hari"},
          {title:"Rata-rata kWh/Hari", field:"avg", readonly:true}
        ]
      },

      "TENANT": {
        cols:[
          {title:"No", field:"no"},
          {title:"Tenant", field:"tenant"},
          {group:"Listrik (kWh)", fields:[
            {title:"Awal", field:"tL1Awal"},
            {title:"Akhir", field:"tL1Akhir"},
            {title:"Pakai", field:"tL1Pakai", readonly:true}
          ]},
          {group:"Air (m3)", fields:[
            {title:"Awal", field:"tAirAwal"},
            {title:"Akhir", field:"tAirAkhir"},
            {title:"Pakai", field:"tAirPakai", readonly:true}
          ]},
          {title:"Hari", field:"hari"},
          {title:"Catatan", field:"note"}
        ]
      },

      "LIFT-ESC": {
        cols:[
          {title:"No", field:"no"},
          {title:"Lokasi", field:"lokasi"},
          {title:"Start Count Awal", field:"startAwal"},
          {title:"Start Count Akhir", field:"startAkhir"},
          {title:"Count Pakai", field:"countPakai", readonly:true},
          {title:"Energi kWh Awal", field:"liftEngAwal"},
          {title:"Energi kWh Akhir", field:"liftEngAkhir"},
          {title:"Energi Pakai", field:"liftEngPakai", readonly:true},
          {title:"Hari", field:"hari"}
        ]
      }
    };

    let currentCategory = "";
    let tableState = {}; // store number of rows/content per category (so Export All can include created ones)

    function changeCategory(){
      const sel = document.getElementById('kategori');
      currentCategory = sel.value;
      renderFormForCategory(currentCategory);
    }

    function renderFormForCategory(cat){
      const area = document.getElementById('formArea');
      if(!cat || !templates[cat]) { area.innerHTML = "<div class='muted'>Pilih kategori di atas.</div>"; return; }
      const tpl = templates[cat];
      // build table html with group headers if any
      let html = `<div class="card"><h3 style="margin:0 0 6px">${cat}</h3><table id="table-${escapeId(cat)}"><thead>`;
      // detect if there are group headers (objects with group)
      // build first row of header (group titles or single)
      let firstRow = "<tr>";
      let secondRow = "<tr>";
      tpl.cols.forEach(col=>{
        if(col.group){
          firstRow += `<th colspan="${col.fields.length}">${col.group}</th>`;
          col.fields.forEach(f=> secondRow += `<th>${f.title}</th>`);
        } else if(col.fields){
          // not used here
        } else {
          firstRow += `<th rowspan="2">${col.title}</th>`;
        }
      });
      firstRow += "</tr>";
      secondRow += "</tr>";
      html += firstRow + secondRow + `</thead><tbody>`;
      // initial single row
      html += buildRowHtml(cat,1);
      html += `</tbody></table></div>`;
      area.innerHTML = html;
      // store default rows
      tableState[cat] = tableState[cat] || {rows:1};
    }

    function buildRowHtml(cat, idx){
      const tpl = templates[cat];
      let row = `<tr data-row="${idx}">`;
      tpl.cols.forEach(col=>{
        if(col.group){
          col.fields.forEach(f=>{
            row += `<td>${inputForField(f.field,f.readonly)}</td>`;
          });
        } else {
          row += `<td>${inputForField(col.field, col.readonly, col.title)}</td>`;
        }
      });
      row += `</tr>`;
      return row;
    }

    function inputForField(fieldName, readonly=false, label){
      readonly = !!readonly;
      // determine type by keywords
      let type = "text";
      if(/awal|akhir|pakai|eng|count|start|rh|tL1|tAir|wbp|lwbp|kvar/i.test(fieldName)) type="number";
      if(/tanggal|date/i.test(fieldName)) type="date";
      if(readonly) return `<div class="muted" data-field="${fieldName}"></div>`;
      if(type==="number") return `<input type="number" data-field="${fieldName}" />`;
      if(type==="date") return `<input type="date" data-field="${fieldName}" />`;
      return `<input type="text" data-field="${fieldName}" />`;
    }

    function addRow(){
      if(!currentCategory) return alert("Pilih kategori dulu.");
      const table = document.getElementById(`table-${escapeId(currentCategory)}`);
      const tbody = table.querySelector("tbody");
      const idx = (tbody.rows.length)+1;
      const newRowHtml = buildRowHtml(currentCategory, idx);
      tbody.insertAdjacentHTML('beforeend', newRowHtml);
      tableState[currentCategory] = tableState[currentCategory] || {};
      tableState[currentCategory].rows = tbody.rows.length;
    }

    function calculate(){
      if(!currentCategory) return alert("Pilih kategori dulu.");
      const table = document.getElementById(`table-${escapeId(currentCategory)}`);
      const tpl = templates[currentCategory];
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach((row, rIdx) => {
        // helper to get input value by field name for this row
        const val = (fName)=>{
          const el = row.querySelector(`[data-field="${fName}"]`);
          if(!el) return 0;
          const v = el.value;
          return v===""||v==null ? 0 : Number(v);
        };
        const set = (fName, text)=>{
          const target = row.querySelector(`[data-field="${fName}"]`) || row.querySelector(`div[data-field="${fName}"]`);
          if(target){
            if(target.tagName==="DIV") target.innerText = text;
            else target.value = text;
          } else {
            // try to find plain cell where readonly text sits (fallback)
            tpl.cols.forEach(c=>{
              if(c.group){
                c.fields.forEach(ff=>{
                  if(ff.field===fName){
                    // find cell index
                    const cells = [...row.children];
                    // brute force: set cell by matching first empty readonly
                    for(let td of cells){
                      if(td && td.innerText.trim()==="") { td.innerText=text; break; }
                    }
                  }
                })
              }
            })
          }
        };

        // per template type compute common ops
        if(currentCategory==="AMR PLN"){
          // LWBP
          let la = val('lwbpAwal');
          let lk = val('lwbpAkhir');
          let lh = val('lwbpHari') || 1;
          let lp = lk - la;
          set('lwbpPakai', lp);

          // WBP
          let wa = val('wbpAwal');
          let wk = val('wbpAkhir');
          let wh = val('wbpHari') || 1;
          let wp = wk - wa;
          set('wbpPakai', wp);

          // KVARh
          let ka = val('kvarAwal');
          let kk = val('kvarAkhir');
          let kh = val('kvarHari') || 1;
          let kp = kk - ka;
          set('kvarPakai', kp);

          let total = (lp||0) + (wp||0);
          set('totalKwh', total);
          let avg = (lh>0) ? (total / lh).toFixed(2) : 0;
          set('avgPerDay', avg);
        }

        else if(currentCategory==="HOTEL"){
          let wpa = val('hotelWbpAwal');
          let wpk = val('hotelWbpAkhir');
          let wp = wpk - wpa;
          set('hotelWbpPakai', wp);

          let la = val('hotelLwbpAwal');
          let lk = val('hotelLwbpAkhir');
          let lp = lk - la;
          set('hotelLwbpPakai', lp);

          let total = (wp||0) + (lp||0);
          set('hotelTotal', total);
          // no average column in hotel template but could be added if needed
        }

        else if(currentCategory==="LVMDP" || currentCategory==="WATER METER"){
          let a = val('awal'), b = val('akhir'), h = val('hari')||1;
          let p = b - a;
          set('pakai', p);
          set('avg', (h>0? (p/h).toFixed(2):0));
        }

        else if(currentCategory==="AHU"){
          let rha = val('rhAwal'), rhk = val('rhAkhir');
          let rhp = rhk - rha; set('rhPakai', rhp);
          let ea = val('engAwal'), ek = val('engAkhir'); let ep = ek-ea; set('engPakai', ep);
          let h = val('hari') || 1; set('avg', (h>0? (ep/h).toFixed(2):0));
        }

        else if(currentCategory==="TENANT"){
          let la = val('tL1Awal'), lk = val('tL1Akhir'); let lp = lk-la; set('tL1Pakai', lp);
          let aa = val('tAirAwal'), ak = val('tAirAkhir'); let ap = ak-aa; set('tAirPakai', ap);
        }

        else if(currentCategory==="LIFT-ESC"){
          let sa = val('startAwal'), sk = val('startAkhir'); set('countPakai', sk-sa);
          let ea = val('liftEngAwal'), ek = val('liftEngAkhir'); set('liftEngPakai', ek-ea);
        }

      });
    }

    // Export current visible sheet
    function exportCurrent(){
      if(!currentCategory) return alert("Pilih kategori dulu.");
      calculate(); // ensure latest
      const table = document.getElementById(`table-${escapeId(currentCategory)}`);
      const date = document.getElementById('globalDate').value || '';
      const wb = XLSX.utils.book_new();
      // add date header as A1
      const aoa = [[`Tanggal:`, date], []];
      const sheet = XLSX.utils.table_to_sheet(table);
      XLSX.utils.sheet_add_aoa(sheet, aoa, {origin: "A1"});
      XLSX.utils.book_append_sheet(wb, sheet, currentCategory);
      XLSX.writeFile(wb, `Pemakaian_${currentCategory.replace(/\s+/g,'_')}.xlsx`);
    }

    // Export all categories present on page
    function exportAll(){
      // find all rendered tables
      const date = document.getElementById('globalDate').value || '';
      const wb = XLSX.utils.book_new();
      const cats = Object.keys(templates);
      cats.forEach(cat=>{
        const table = document.getElementById(`table-${escapeId(cat)}`);
        if(!table) return;
        // run a calculate for that category by temporarily setting currentCategory
        const prev = currentCategory;
        currentCategory = cat;
        calculate();
        currentCategory = prev;
        const sheet = XLSX.utils.table_to_sheet(table);
        XLSX.utils.sheet_add_aoa(sheet, [[`Tanggal:`, date], []], {origin:"A1"});
        XLSX.utils.book_append_sheet(wb, sheet, cat.substring(0,31));
      });
      XLSX.writeFile(wb, `Pemakaian_All_Categories.xlsx`);
    }

    // utility to produce element-safe id
    function escapeId(s){ return s.replace(/[^a-z0-9]/gi,'_'); }

    // initial render placeholder
    document.getElementById('formArea').innerHTML = "<div class='muted'>Pilih kategori di atas â€” setiap kategori menampilkan tabel input sesuai template. Setelah input, klik Hitung lalu Export.</div>";
  </script>
</body>
</html>
