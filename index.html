<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Utility - Input & Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{--bg:#f5f7fb;--card:#fff;--primary:#2563eb;--muted:#6b7280}
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:18px;color:#0f172a}
    .container{max-width:1200px;margin:0 auto}
    h1{color:var(--primary);margin-bottom:6px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:14px}
    label{display:block;font-weight:700;color:var(--muted);font-size:13px}
    select,input,button{padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fff}
    .controls{display:flex;gap:12px;align-items:end;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th,td{border:1px solid #e6eefb;padding:8px;text-align:center}
    thead th{background:linear-gradient(90deg,#1e3a8a,#3b82f6);color:#fff}
    input[type="number"]{width:120px}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
    .btn-primary{background:var(--primary)}
    .btn-danger{background:#dc2626}
    .btn-ghost{background:#64748b}
    .small{width:100px}
    .flex{display:flex;gap:8px;align-items:center}
    #summary{margin-top:10px;padding:10px;border-left:4px solid var(--primary);background:#eef2ff;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š Utility Input & Dashboard</h1>

    <!-- FORM INPUT -->
    <div class="card">
      <div class="controls">
        <div>
          <label>Tanggal (untuk export / referensi)</label>
          <input type="date" id="globalDate" />
        </div>

        <div>
          <label>Pilih Kategori</label>
          <select id="kategori" onchange="renderCategory()">
            <option value="">-- pilih kategori --</option>
            <option value="PLN">PLN</option>
            <option value="LVMDP">LVMDP</option>
            <option value="AHU">AHU</option>
            <option value="WATER">WATER METER</option>
          </select>
        </div>

        <div style="margin-left:auto" class="actions">
          <button class="btn btn-primary" onclick="saveVisible()">Simpan</button>
          <button class="btn btn-primary" onclick="exportCurrent()">Export Sheet</button>
          <button class="btn btn-ghost" onclick="exportAll()">Export Semua</button>
        </div>
      </div>

      <div id="formArea" style="margin-top:12px"></div>
      <div id="summary" style="display:none"></div>
    </div>

    <!-- DASHBOARD -->
    <div class="card">
      <h3>Dashboard Cepat</h3>
      <div class="flex">
        <label>Kategori</label>
        <select id="dashCat">
          <option value="PLN">PLN</option>
          <option value="LVMDP">LVMDP</option>
          <option value="AHU">AHU</option>
          <option value="WATER">WATER METER</option>
        </select>
        <label>Bulan</label>
        <input type="month" id="dashMonth" value="">
        <button class="btn btn-primary" onclick="loadDashboard()">Tampilkan</button>
        <button class="btn btn-ghost" onclick="clearChart()">Clear Chart</button>
      </div>
      <div style="margin-top:12px">
        <canvas id="chart" height="120"></canvas>
      </div>
    </div>
  </div>

<script>
/* ========= GANTI DENGAN FIREBASE CONFIG PROJECTMU ========= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ======= Helpers tanggal ======= */
function todayId(){
  const d = new Date();
  return d.toISOString().slice(0,10); // YYYY-MM-DD
}

/* ================== RENDER FORMS ================== */
function renderCategory(){
  const cat = document.getElementById('kategori').value;
  const area = document.getElementById('formArea');
  document.getElementById('summary').style.display='none';
  if(!cat){ area.innerHTML = '<div class="muted">Pilih kategori untuk tampilkan form input.</div>'; return; }

  if(cat === 'PLN'){
    area.innerHTML = renderPLNForm();
    autoFillPLNStarts();
  } else if(cat === 'LVMDP'){
    area.innerHTML = renderLVMDPForm();
  } else if(cat === 'AHU'){
    area.innerHTML = renderAHUForm();
  } else if(cat === 'WATER'){
    area.innerHTML = renderWaterForm();
  }
}

function renderPLNForm(){
  return `
    <h3>PLN (AMR)</h3>
    <table id="tblPLN"><thead>
      <tr><th>Meter</th><th>Stand Awal</th><th>Stand Akhir</th><th>Pemakaian</th></tr>
    </thead><tbody>
      <tr><td>LWBP (kWh)</td><td><input type="number" data-field="lwbpAwal" /></td><td><input type="number" data-field="lwbpAkhir" /></td><td><div data-field="lwbpPakai" class="muted"></div></td></tr>
      <tr><td>WBP (kWh)</td><td><input type="number" data-field="wbpAwal" /></td><td><input type="number" data-field="wbpAkhir" /></td><td><div data-field="wbpPakai" class="muted"></div></td></tr>
      <tr><td>KVARh</td><td><input type="number" data-field="kvarAwal" /></td><td><input type="number" data-field="kvarAkhir" /></td><td><div data-field="kvarPakai" class="muted"></div></td></tr>
      <tr><td><strong>Total kWh</strong></td><td colspan="3"><div data-field="totalKwh" class="muted"></div></td></tr>
    </tbody></table>
  `;
}
async function autoFillPLNStarts(){
  try{
    const snap = await db.collection('utility_usage').doc('PLN').collection('readings').orderBy('timestamp','desc').limit(1).get();
    if(snap.empty) return;
    const last = snap.docs[0].data();
    ['lwbpAkhir','wbpAkhir','kvarAkhir'].forEach(key=>{
      const el = document.querySelector(`[data-field="${key.replace('Akhir','Awal')}"]`);
      if(el && last[key]!==undefined) el.value = last[key];
    });
  }catch(e){ console.error(e); }
}

function renderLVMDPForm(){
  const names = ['LVMDP1','LVMDP2','LVMDP3','LVMDP4'];
  return `<h3>LVMDP (MWh)</h3>
    <table id="tblLVMDP"><thead><tr><th>Nama Panel</th><th>Pemakaian Hari Ini (MWh)</th></tr></thead><tbody>
    ${names.map(n=>`<tr><td><input type="text" value="${n}" readonly/></td><td><input type="number" data-field="pemakaian"/></td></tr>`).join('')}
    </tbody></table>`;
}

function renderAHUForm(){
  const names = ['SDB-AC.A','SDB-AC.B','SDB-AC.C','SDB-AC.D'];
  return `<h3>AHU (kWh)</h3>
    <table id="tblAHU"><thead><tr><th>Nama Panel</th><th>Pemakaian Hari Ini (kWh)</th></tr></thead><tbody>
    ${names.map(n=>`<tr><td><input type="text" value="${n}" readonly/></td><td><input type="number" data-field="pemakaian"/></td></tr>`).join('')}
    </tbody></table>`;
}

function renderWaterForm(){
  return `<h3>Water Meter</h3>
    <button class="btn btn-primary" onclick="addWaterRow()">+ Tambah Baris</button>
    <table id="tblWATER"><thead><tr><th>Nama</th><th>Pemakaian Hari Ini (mÂ³)</th><th>Aksi</th></tr></thead><tbody></tbody></table>`;
}
function addWaterRow(name=''){
  const tbody=document.querySelector('#tblWATER tbody');
  const row=document.createElement('tr');
  row.innerHTML=`<td><input type="text" value="${name}" /></td><td><input type="number" data-field="pemakaian"/></td><td><button onclick="this.closest('tr').remove()" class="btn btn-ghost">Hapus</button></td>`;
  tbody.appendChild(row);
}

/* ================== DASHBOARD GRAFIK ================== */
let chartInstance=null;
async function loadDashboard(){
  const cat=document.getElementById('dashCat').value;
  const month=document.getElementById('dashMonth').value;
  if(!month) return alert('Pilih bulan dulu');

  const snap=await db.collection('utility_usage').doc(cat).collection('readings').orderBy('timestamp','asc').get();
  const data=snap.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.id.startsWith(month));
  if(data.length===0) return alert('Tidak ada data');

  const labels=[],values=[];
  data.forEach(d=>{
    labels.push(d.id);
    if(cat==='PLN') values.push(d.totalKwh||0);
    else if(d.items){ values.push(d.items.reduce((s,it)=>s+(it.pemakaian||0),0)); }
    else { values.push(d.value||0); }
  });

  const colors={PLN:'#2563eb',LVMDP:'#16a34a',AHU:'#f59e0b',WATER:'#06b6d4'};
  const color=colors[cat]||'#2563eb';

  const ctx=document.getElementById('chart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{label:`Pemakaian ${cat}`,data:values,borderColor:color,backgroundColor:color+'33',tension:0.3,fill:true,pointRadius:5,pointBackgroundColor:color,pointHoverRadius:7}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:`Grafik Pemakaian ${cat} (${month})`,font:{size:16,weight:'bold'}},tooltip:{callbacks:{label:(ctx)=>` ${ctx.formattedValue} ${cat==='WATER'?'mÂ³':'kWh'}`}}},
      scales:{y:{beginAtZero:true,title:{display:true,text:'Pemakaian'}},x:{title:{display:true,text:'Tanggal'}}},
      animation:{duration:800,easing:'easeOutQuart'}
    }
  });
}
function clearChart(){if(chartInstance){chartInstance.destroy();chartInstance=null;}}

/* ================== INIT ================== */
(function init(){
  const m=new Date(); 
  document.getElementById('dashMonth').value=m.toISOString().slice(0,7);
  document.getElementById('globalDate').value=todayId();
})();
</script>
</body>
</html>
